I"±i<blockquote>
  <p>åŸæ–‡ç”± Trisha Gee åœ¨2019å¹´12æœˆ13æ—¥å‘å¸ƒåœ¨ <a href="https://blog.jetbrains.com/idea/2019/12/tutorial-reactive-spring-boot-java-rsocket-client/">INTELLIJ IDEA BLOG</a></p>
</blockquote>

<p>åœ¨è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªRSocketå®¢æˆ·ç«¯ï¼Œç”¨æ¥è¿æ¥ä¸Šä¸€èŠ‚åˆ›å»ºçš„RSocketæœåŠ¡å™¨ã€‚</p>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬æœ‰äº†ä¸€ä¸ªä½¿ç”¨Spring WebClientçš„ç«¯åˆ°ç«¯åº”ç”¨ç¨‹åºã€‚åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†ä¸€ä¸ªæ–°çš„RSocketæœåŠ¡å™¨ï¼Œåœ¨è¿™èŠ‚ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•åˆ›å»ºä¸€ä¸ªå®¢æˆ·ç«¯æ¥è¿æ¥å®ƒ</p>

<!--more-->

<h3 id="åˆ›å»ºä¸€ä¸ªé›†æˆæµ‹è¯•">åˆ›å»ºä¸€ä¸ªé›†æˆæµ‹è¯•</h3>

<p>ä¸<code class="highlighter-rouge">WebClientStockClient</code>ä¸€æ ·ï¼Œæˆ‘ä»¬å°†é€šè¿‡é›†æˆæµ‹è¯•æ¥é©±åŠ¨RSocketå®¢æˆ·ç«¯ï¼Œæµ‹è¯•çœ‹èµ·æ¥ä¸<code class="highlighter-rouge">WebClientStockClientIntegrationTest</code>å‡ ä¹ç›¸åŒã€‚</p>

<ol>
  <li>æ‰€ä»¥è®©æˆ‘ä»¬å¤åˆ¶è¿™ä¸ªæµ‹è¯•å¹¶å°†å…¶é‡å‘½åä¸º<code class="highlighter-rouge">RSocketStockClientIntegrationTest</code>ã€‚</li>
  <li>å°†å˜é‡<code class="highlighter-rouge">WebClientStockClient</code>æ”¹ä¸º<code class="highlighter-rouge">RSocketStockClient</code>å¹¶é‡å‘½åä¸º<code class="highlighter-rouge">rSocketStockClient</code>ã€‚</li>
  <li>ï¼ˆæç¤ºï¼šä½¿ç”¨IntelliJ IDEAçš„rename refactoringæ¥é‡å‘½åï¼Œä¼šå°†å…¶ä½™åœ°æ–¹ç”¨åˆ°çš„è¿™ä¸ªå˜é‡éƒ½é‡å‘½åäº†ï¼Œä¸éœ€è¦æŸ¥æ‰¾å’Œæ›¿æ¢ï¼‰ã€‚</li>
  <li>æˆ‘ä»¬çŸ¥é“è¿™ä¸éœ€è¦WebClientï¼Œå› ä¸º<code class="highlighter-rouge">WebClientStockClient</code>æ‰éœ€è¦çš„ã€‚ç§»é™¤æ„é€ å‡½æ•°å‚æ•°å’Œå­—æ®µå£°æ˜ã€‚</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">RSocketStockClientIntegrationTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">shouldRetrieveStockPricesFromTheService</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// given</span>
        <span class="nc">RSocketStockClient</span> <span class="n">rSocketStockClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RSocketStockClient</span><span class="o">();</span>
 
        <span class="c1">// when</span>
        <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">StockPrice</span><span class="o">&gt;</span> <span class="n">prices</span> <span class="o">=</span> <span class="n">rSocketStockClient</span><span class="o">.</span><span class="na">pricesFor</span><span class="o">(</span><span class="s">"SYMBOL"</span><span class="o">);</span>
 
        <span class="c1">// then</span>
        <span class="nc">Assertions</span><span class="o">.</span><span class="na">assertNotNull</span><span class="o">(</span><span class="n">prices</span><span class="o">);</span>
        <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">StockPrice</span><span class="o">&gt;</span> <span class="n">fivePrices</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="na">take</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="n">fivePrices</span><span class="o">.</span><span class="na">count</span><span class="o">().</span><span class="na">block</span><span class="o">());</span>
        <span class="nc">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">"SYMBOL"</span><span class="o">,</span> <span class="n">fivePrices</span><span class="o">.</span><span class="na">blockFirst</span><span class="o">().</span><span class="na">getSymbol</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ï¼ˆæ³¨æ„ï¼šè¿™ä»£ç ç°åœ¨è¿˜æœªèƒ½é€šè¿‡ç¼–è¯‘ï¼‰</p>

<h3 id="åˆ›å»º-rsocket-å®¢æˆ·ç«¯">åˆ›å»º RSocket å®¢æˆ·ç«¯</h3>

<ol>
  <li><code class="highlighter-rouge">RSocketStockClient</code>è¿˜ä¸å­˜åœ¨ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç©ºç±»ã€‚</li>
  <li>ï¼ˆæç¤ºï¼šåœ¨çº¢è‰²çš„<code class="highlighter-rouge">RSocketStockClient</code>ä»£ç æŒ‰ä¸‹ Alt+Enterä¼šç»™æˆ‘ä»¬é€‰æ‹©åˆ›å»ºè¿™ä¸ªç±»ï¼‰</li>
  <li>æµ‹è¯•å‡å®šè¦ä¸€ä¸ª<code class="highlighter-rouge">pricesFor</code>æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨<code class="highlighter-rouge">RSocketStockClient</code>é‡Œé¢åˆ›å»ºè¿™ä¸ªç¼ºå°‘çš„æ–¹æ³•ã€‚</li>
  <li>ï¼ˆæç¤ºï¼šåœ¨<code class="highlighter-rouge">RSocketStockClient</code>é‡Œçº¢è‰²çš„<code class="highlighter-rouge">pricesFor</code>æ–¹æ³•æŒ‰ä¸‹Alt+Enterä¼šç»™æˆ‘ä»¬åˆ›å»ºè¿™ä¸ªæ–¹æ³•çš„é€‰æ‹©ï¼Œå¹¶ä¸”æœ‰æ­£ç¡®çš„æ–¹æ³•ç­¾åã€‚)</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RSocketStockClient</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">StockPrice</span><span class="o">&gt;</span> <span class="nf">pricesFor</span><span class="o">(</span><span class="nc">String</span> <span class="n">symbol</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="å¼•å…¥-stockclient-æ¥å£">å¼•å…¥ StockClient æ¥å£</h3>

<p>å½“ç„¶æ–¹æ³•å£°æ˜çœ‹èµ·æ¥è·Ÿåœ¨<code class="highlighter-rouge">WebClientStockClient</code>é‡Œé¢çš„ä¸€æ ·ï¼Œæ‰€ä»¥è¿™æ˜¯å¼•å…¥æ¥å£çš„å¥½æ—¶æœºï¼Œè®©ä¸¤ä¸ªå®¢æˆ·ç«¯éƒ½å®ç°åŒæ ·çš„æ¥å£ã€‚</p>

<ol>
  <li>åˆ›å»ºä¸€ä¸ªæ¥å£<code class="highlighter-rouge">StockClient</code>æˆ‘ä»¬å¸Œæœ›<code class="highlighter-rouge">pricesFor</code>æ–¹æ³•å‡ºç°åœ¨æ¥å£ä¸Šï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•åœ¨ä¸¤ä¸ªå®¢æˆ·ç«¯ç±»çš„æ–¹æ³•ç­¾åä¸€æ ·çš„ã€‚</li>
  <li>ï¼ˆæç¤ºï¼šåœ¨<code class="highlighter-rouge">WebClientStockClient</code>ä¸Šä½¿ç”¨IntelliJ IDEAçš„Extract Interface åŠŸèƒ½ï¼Œå¯ä»¥è‡ªåŠ¨åœ°åˆ›å»ºä¸€ä¸ªå¸¦æœ‰ <code class="highlighter-rouge">pricesFor</code>æ–¹æ³•çš„æ¥å£ã€‚ï¼‰</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">StockClient</span> <span class="o">{</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">StockPrice</span><span class="o">&gt;</span> <span class="nf">pricesFor</span><span class="o">(</span><span class="nc">String</span> <span class="n">symbol</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>ç¡®ä¿<code class="highlighter-rouge">WebClientStockClient</code>å·²ç»æ›´æ–°ä¸ºå®ç°æ–°çš„<code class="highlighter-rouge">StockClient</code>æ¥å£äº†ï¼Œå¹¶ä¸”æ·»åŠ äº†<code class="highlighter-rouge">@Override</code>æ³¨è§£åˆ°<code class="highlighter-rouge">pricesFor</code>æ–¹æ³•ä¸Šã€‚</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebClientStockClient</span> <span class="kd">implements</span> <span class="nc">StockClient</span> <span class="o">{</span>
    <span class="c1">// è¿™é‡Œè¿›è¡Œåˆå§‹åŒ–...</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">StockPrice</span><span class="o">&gt;</span> <span class="nf">pricesFor</span><span class="o">(</span><span class="nc">String</span> <span class="n">symbol</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// è¿™é‡Œæ˜¯å®ç°</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>å¯¹<code class="highlighter-rouge">RSocketStockClient</code>ä¹Ÿæ˜¯åŒæ ·çš„æ“ä½œ</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RSocketStockClient</span> <span class="kd">implements</span> <span class="nc">StockClient</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">StockPrice</span><span class="o">&gt;</span> <span class="nf">pricesFor</span><span class="o">(</span><span class="nc">String</span> <span class="n">symbol</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>ç›®å‰æµ‹è¯•èƒ½é€šè¿‡ç¼–è¯‘ï¼Œè¿è¡Œå®ƒçœ‹åˆ°ä¸èƒ½é€šè¿‡æµ‹è¯•ã€‚å®ƒå¤±è´¥çš„åŸå› åº”è¯¥æ˜¯åœ¨<code class="highlighter-rouge">assertNotNull</code>æ–­è¨€ä¸Šï¼Œå› ä¸ºæˆ‘ä»¬ä»<code class="highlighter-rouge">pricesFor</code>æ–¹æ³•è¿”å›nullã€‚</li>
</ol>

<h3 id="å®ç°rsocketé“¾æ¥">å®ç°RSocketé“¾æ¥</h3>

<p>é€šå¸¸ åœ¨æµ‹è¯•é©±åŠ¨å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¼šé‡‡å–ä¸€äº›å°æ­¥éª¤æ¥ä½¿æµ‹è¯•é€šè¿‡ï¼Œç„¶åå†æœ‰æ›´è¯¦ç»†çš„æµ‹è¯•ã€‚åœ¨æœ¬è¯¾ç¨‹ä¸­æˆ‘ä»¬å°†ç›´æ¥è¿›å…¥å¹¶å®ç°èƒ½ç”¨çš„RSocketå®¢æˆ·ç«¯ã€‚</p>

<ol>
  <li>åœ¨stock-clientæ¨¡å—æ·»åŠ ä¸€ä¸ª<a href="https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-rsocket">spring-boot-starter-rsocket</a>ä¾èµ–åˆ°pom.xmlæ–‡ä»¶</li>
</ol>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependencies&gt;</span>
	<span class="nt">&lt;dependency&gt;</span>
		<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
		<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-webflux<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;/dependency&gt;</span>
	<span class="nt">&lt;dependency&gt;</span>
		<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
		<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-rsocket<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;/dependency&gt;</span>
	<span class="c">&lt;!-- more dependencies... --&gt;</span>
</code></pre></div></div>

<ol>
  <li>æ·»åŠ ä¸€ä¸ªç±»å‹ä¸º<code class="highlighter-rouge">RSocketRequester</code>çš„å­—æ®µ<code class="highlighter-rouge">rSocketRequester</code>åˆ°<code class="highlighter-rouge">RSocketStockClient</code>ã€‚</li>
  <li>ä¸ºå®ƒæ·»åŠ ä¸€ä¸ªæ„é€ å‡½æ•°å‚æ•°</li>
  <li>ï¼ˆæç¤ºï¼šIntelliJ IDEAå¯ä»¥ä¸ºå­—æ®µè‡ªåŠ¨ç”Ÿæ„é€ å‡½æ•°å‚æ•°ï¼‰</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RSocketStockClient</span> <span class="kd">implements</span> <span class="nc">StockClient</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">RSocketRequester</span> <span class="n">rSocketRequester</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">RSocketStockClient</span><span class="o">(</span><span class="nc">RSocketRequester</span> <span class="n">rSocketRequester</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">rSocketRequester</span> <span class="o">=</span> <span class="n">rSocketRequester</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="c1">// pricesFor æ–¹æ³•...</span>
<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>åœ¨<code class="highlighter-rouge">pricesFor</code>æ–¹æ³•ï¼Œè°ƒç”¨<code class="highlighter-rouge">rSocketRequester.route</code>ã€‚ å¯¹äºè·¯ç”±ï¼Œæˆ‘ä»¬æƒ³è¦ä½¿ç”¨è·Ÿåœ¨åç«¯RSocketæœåŠ¡å®šä¹‰çš„ç›¸åŒï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯â€œstockPricesâ€ã€‚</li>
  <li>é€šè¿‡<code class="highlighter-rouge">data</code>æ–¹æ³•å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªè‚¡ç¥¨ä»£å·ã€‚</li>
  <li>æˆ‘ä»¬æœŸæœ›è°ƒç”¨è¿”å›ä¸€ä¸ªè‚¡ç¥¨ä»·æ ¼çš„<code class="highlighter-rouge">Flux</code>ï¼Œæ‰€ä»¥å°†<code class="highlighter-rouge">StockPrice.class</code>ä¼ å…¥åˆ°<code class="highlighter-rouge">retrieveFlux</code>æ–¹æ³•ã€‚</li>
  <li>è¿”å›è¿™äº›è°ƒç”¨<code class="highlighter-rouge">pricesFor</code>æ–¹æ³•çš„ç»“æœï¼Œè€Œä¸æ˜¯<code class="highlighter-rouge">null</code>ã€‚</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RSocketStockClient</span> <span class="kd">implements</span> <span class="nc">StockClient</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">RSocketRequester</span> <span class="n">rSocketRequester</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">RSocketStockClient</span><span class="o">(</span><span class="nc">RSocketRequester</span> <span class="n">rSocketRequester</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">rSocketRequester</span> <span class="o">=</span> <span class="n">rSocketRequester</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">StockPrice</span><span class="o">&gt;</span> <span class="nf">pricesFor</span><span class="o">(</span><span class="nc">String</span> <span class="n">symbol</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">rSocketRequester</span><span class="o">.</span><span class="na">route</span><span class="o">(</span><span class="s">"stockPrices"</span><span class="o">)</span>
                               <span class="o">.</span><span class="na">data</span><span class="o">(</span><span class="n">symbol</span><span class="o">)</span>
                               <span class="o">.</span><span class="na">retrieveFlux</span><span class="o">(</span><span class="nc">StockPrice</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="åˆ›å»ºä¸€ä¸ª-rsocketrequester">åˆ›å»ºä¸€ä¸ª RSocketRequester</h3>

<p>æµ‹è¯•ä»£ç ä¸èƒ½é€šè¿‡ç¼–è¯‘ï¼Œå› ä¸ºæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ª<code class="highlighter-rouge">rSocketRequester</code>åˆ°æ„é€ å‡½æ•°å‚æ•°ï¼Œç„¶è€Œåœ¨æµ‹è¯•é‡Œæˆ‘ä»¬æ²¡æœ‰<code class="highlighter-rouge">RSocketRequester</code>å®ä¾‹ã€‚</p>

<ol>
  <li>åœ¨æµ‹è¯•é‡Œåˆ›å»ºä¸€ä¸ªåä¸º<code class="highlighter-rouge">createRSocketRequester</code>çš„ç§æœ‰æ–¹æ³•ï¼Œæ”¾åœ¨ä¸Šæ–¹é è¿‘å…¶å®ƒå¯¹è±¡åˆå§‹åŒ–çš„ä½ç½®ã€‚</li>
  <li>ä¸º<code class="highlighter-rouge">RSocketRequester.Builder</code>åˆ›å»ºä¸€ä¸ªå­—æ®µã€‚å¦‚æœæˆ‘ä»¬æ·»åŠ <code class="highlighter-rouge">@Autowired</code>æ³¨è§£ï¼ŒSpringå°†ä¼šä¸ºæˆ‘ä»¬çš„æµ‹è¯•æ³¨å…¥ä¸€ä¸ªå®ä¾‹ã€‚</li>
  <li>è¦è®©Springç®¡ç†æˆ‘ä»¬çš„æµ‹è¯•ï¼Œæˆ‘ä»¬éœ€è¦å°†å®ƒæ³¨è§£ä¸º<code class="highlighter-rouge">@SpringBootTest</code>ã€‚</li>
  <li>åœ¨<code class="highlighter-rouge">createRSocketRequester</code>é‡Œé¢ï¼Œä½¿ç”¨<code class="highlighter-rouge">rSocketRequester</code>é€šè¿‡TCPè¿æ¥åˆ°æˆ‘ä»¬çš„RSocketæœåŠ¡å™¨ï¼Œå®ƒè¿è¡Œåœ¨localhostçš„7000ç«¯å£ã€‚</li>
  <li>è°ƒç”¨<code class="highlighter-rouge">block</code>ç›´åˆ°è¿æ¥ä¸Šã€‚</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootTest</span>
<span class="kd">class</span> <span class="nc">RSocketStockClientIntegrationTest</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">RSocketRequester</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span><span class="o">;</span>
 
    <span class="kd">private</span> <span class="nc">RSocketRequester</span> <span class="nf">createRSocketRequester</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">connectTcp</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">7000</span><span class="o">).</span><span class="na">block</span><span class="o">();</span>
    <span class="o">}</span>
 
    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">shouldRetrieveStockPricesFromTheService</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// implementation...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="é€šè¿‡é›†æˆæµ‹è¯•">é€šè¿‡é›†æˆæµ‹è¯•</h3>

<p>æˆ‘ä»¬æœŸå¾…è¿™ä¸ªæµ‹è¯•èƒ½è¿è¡Œï¼Œä½†æˆ‘ä»¬é”™è¿‡äº†ä¸€äº›é‡è¦çš„ä¸œè¥¿ã€‚æˆ‘ä»¬å‘ç°ä¸ªé”™è¯¯ï¼Œè¯´missing a SpringBootConfigurationçœ‹èµ·æ¥å¯èƒ½æœ‰ç‚¹ä»¤äººè´¹è§£ã€‚å®é™…ä¸Šï¼Œè¿™ä¸ªæ¨¡å—å¹¶æ²¡æœ‰ä»»ä½•SpringBootApplicationã€‚å› ä¸ºè¿™æ˜¯ç”¨äºä½œä¸ºä¸€ä¸ªåº“ï¼Œç»™å…¶å®ƒåº”ç”¨ä»£ç å…±äº«ä»£ç çš„ï¼Œå®ƒæœ¬èº«ä¸æ˜¯ä¸€ä¸ªåº”ç”¨ç¨‹åºã€‚è®©æˆ‘ä»¬çœ‹ä¸€ç§è§£å†³æ–¹æ¡ˆè®©æµ‹è¯•è·‘èµ·æ¥ã€‚</p>

<ol>
  <li>åœ¨testç›®å½•é‡Œåˆ›å»ºä¸€ä¸ªç±»<code class="highlighter-rouge">TestApplication</code>ã€‚</li>
  <li>å°†å®ƒæ³¨è§£ä¸º<code class="highlighter-rouge">@SpringBootApplication</code>ã€‚</li>
  <li>é‡æ–°è¿è¡Œé›†æˆæµ‹è¯•ï¼Œæ‰€æœ‰ä¸œè¥¿åº”è¯¥æŒ‰é¢„æœŸå¯åŠ¨ï¼Œå¹¶ä¸”æµ‹è¯•åº”è¯¥é€šè¿‡äº†ã€‚</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestApplication</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="ä½¿ç”¨-stepverifier-è¿›è¡Œæµ‹è¯•">ä½¿ç”¨ StepVerifier è¿›è¡Œæµ‹è¯•</h3>

<p>ä¸€æ—¦æµ‹è¯•é€šè¿‡äº†ï¼Œæˆ‘ä»¬å¯ä»¥å‡è®¾å®¢æˆ·ç«¯å·²ç»æˆåŠŸåœ°é€šè¿‡RSocketè¿æ¥åˆ°äº†æœåŠ¡å™¨ï¼Œè·å–ä¸€ä¸ª<code class="highlighter-rouge">Flux</code>çš„<code class="highlighter-rouge">StockPrice</code>å¯¹è±¡ï¼Œå¯ä»¥å»å…¶ä¸­çš„å‰äº”ä¸ªï¼Œç„¶åæ£€æŸ¥ç¬¬ä¸€ä¸ªæ˜¯å¦æœ‰æ­£ç¡®çš„è‚¡ç¥¨ä»£ç ã€‚è¿™æ˜¯ç¨å¾®ç®€å•çš„æµ‹è¯•å“åº”å¼åº”ç”¨ç¨‹åºçš„æ–¹å¼ã€‚è¿˜æœ‰å…¶å®ƒçš„æ–¹å¼ï¼Œå…¶ä¸­ä¸€ç§å°±æ˜¯ä½¿ç”¨StepVerifierä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™æˆ‘ä»¬æœŸæœ›çœ‹åˆ°çš„äº‹ä»¶ã€‚</p>

<ol>
  <li>åˆ›å»ºä¸€ä¸ªæ–°çš„StepVerifierä»prices Fluxé‡Œé¢å–5ä¸ªä»·æ ¼ã€‚</li>
  <li>ä½¿ç”¨<a href="https://projectreactor.io/docs/test/release/api/reactor/test/StepVerifier.Step.html#expectNextMatches-java.util.function.Predicate-">expectNextMatches</a>æ£€æŸ¥æ‰€æœ‰5ä¸ªè‚¡ç¥¨ä»·æ ¼å¯¹åº”çš„è‚¡ç¥¨ä»£ç æ˜¯æ­£ç¡®çš„ã€‚</li>
  <li>è°ƒç”¨å»æ£€æŸ¥ä¸ä»…è¿™äº›æœŸæœ›è¾¾åˆ°äº†ï¼Œå¹¶ä¸”åœ¨è¿™5ä¸ªä¹‹åæ²¡æœ‰æ›´å¤šçš„<code class="highlighter-rouge">StockPrice</code>å¯¹è±¡äº†ã€‚</li>
  <li>åˆ é™¤æ—§çš„æ–­è¨€ï¼ˆStepVerifierå°†å®ƒä»¬å…¨éƒ¨æ›¿æ¢äº†ï¼‰ã€‚</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">shouldRetrieveStockPricesFromTheService</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// given</span>
    <span class="nc">RSocketStockClient</span> <span class="n">rSocketStockClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RSocketStockClient</span><span class="o">(</span><span class="n">createRSocketRequester</span><span class="o">());</span>
 
    <span class="c1">// when</span>
    <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">StockPrice</span><span class="o">&gt;</span> <span class="n">prices</span> <span class="o">=</span> <span class="n">rSocketStockClient</span><span class="o">.</span><span class="na">pricesFor</span><span class="o">(</span><span class="s">"SYMBOL"</span><span class="o">);</span>
 
    <span class="c1">// then</span>
    <span class="nc">StepVerifier</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">prices</span><span class="o">.</span><span class="na">take</span><span class="o">(</span><span class="mi">5</span><span class="o">))</span>
                <span class="o">.</span><span class="na">expectNextMatches</span><span class="o">(</span><span class="n">stockPrice</span> <span class="o">-&gt;</span> <span class="n">stockPrice</span><span class="o">.</span><span class="na">getSymbol</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"SYMBOL"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">expectNextMatches</span><span class="o">(</span><span class="n">stockPrice</span> <span class="o">-&gt;</span> <span class="n">stockPrice</span><span class="o">.</span><span class="na">getSymbol</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"SYMBOL"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">expectNextMatches</span><span class="o">(</span><span class="n">stockPrice</span> <span class="o">-&gt;</span> <span class="n">stockPrice</span><span class="o">.</span><span class="na">getSymbol</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"SYMBOL"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">expectNextMatches</span><span class="o">(</span><span class="n">stockPrice</span> <span class="o">-&gt;</span> <span class="n">stockPrice</span><span class="o">.</span><span class="na">getSymbol</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"SYMBOL"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">expectNextMatches</span><span class="o">(</span><span class="n">stockPrice</span> <span class="o">-&gt;</span> <span class="n">stockPrice</span><span class="o">.</span><span class="na">getSymbol</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"SYMBOL"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">verifyComplete</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This approach can support much more than this simple example, and is also very useful for testing time-based publishers like ours. è¿™ç§æ–¹å¼å¯ä»¥æ”¯æŒæ¯”è¿™ä¸ªç®€å•ä¾‹å­æ›´å¤šçš„æ“ä½œï¼Œè€Œä¸”å¯¹äºæµ‹è¯•åƒæˆ‘ä»¬è¿™ç§åŸºäºæ—¶é—´çš„å‘å¸ƒè€…å¾ˆæœ‰ç”¨ã€‚</p>

<h3 id="æ·»åŠ é‡è¯•é€€é¿å·²ç»é”™è¯¯å¤„ç†ç­–ç•¥">æ·»åŠ é‡è¯•é€€é¿å·²ç»é”™è¯¯å¤„ç†ç­–ç•¥</h3>

<p>æˆ‘ä»¬è¿˜æœ‰æœ€åä¸€ä»¶äº‹è¦è€ƒè™‘ã€‚æˆ‘ä»¬çš„<code class="highlighter-rouge">WebClientStockClient</code>å®šä¹‰äº†ä¸€ä¸ªé€€é¿é‡è¯•ç­–ç•¥ï¼Œä»¥åŠç®€å•çš„é”™è¯¯å¤„ç†æ–¹æ³•ã€‚å®é™…ä¸Šæˆ‘ä»¬å¯¹äº<code class="highlighter-rouge">RSocketStockClient</code>ä¹Ÿé‡‡å–åŒæ ·çš„æ–¹å¼ã€‚</p>

<ol>
  <li>ä»<code class="highlighter-rouge">WebClientStockClient</code>å¤åˆ¶<code class="highlighter-rouge">retryBackoff</code>å’Œ<code class="highlighter-rouge">doOnError</code>æ­¥éª¤å¹¶ç²˜è´´åˆ° <code class="highlighter-rouge">RSocketStockClient.pricesFor</code>é‡Œé¢ã€‚</li>
  <li>é‡æ–°è¿è¡Œæµ‹è¯•ï¼Œå®ƒåº”è¯¥è¿˜èƒ½é€šè¿‡çš„ã€‚</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Log4j2</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RSocketStockClient</span> <span class="kd">implements</span> <span class="nc">StockClient</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">RSocketRequester</span> <span class="n">rSocketRequester</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">RSocketStockClient</span><span class="o">(</span><span class="nc">RSocketRequester</span> <span class="n">rSocketRequester</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">rSocketRequester</span> <span class="o">=</span> <span class="n">rSocketRequester</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Flux</span><span class="o">&lt;</span><span class="nc">StockPrice</span><span class="o">&gt;</span> <span class="nf">pricesFor</span><span class="o">(</span><span class="nc">String</span> <span class="n">symbol</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">rSocketRequester</span><span class="o">.</span><span class="na">route</span><span class="o">(</span><span class="s">"stockPrices"</span><span class="o">)</span>
                               <span class="o">.</span><span class="na">data</span><span class="o">(</span><span class="n">symbol</span><span class="o">)</span>
                               <span class="o">.</span><span class="na">retrieveFlux</span><span class="o">(</span><span class="nc">StockPrice</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                               <span class="o">.</span><span class="na">retryBackoff</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">20</span><span class="o">))</span>
                               <span class="o">.</span><span class="na">doOnError</span><span class="o">(</span><span class="nc">IOException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ç°åœ¨æˆ‘ä»¬åœ¨åç«¯æœ‰äº†å‘é€è‚¡ç¥¨ä»·æ ¼çš„RSocketæœåŠ¡å™¨ï¼Œä»¥åŠèƒ½å¤Ÿè¿æ¥åˆ°å®ƒå¹¶æŸ¥çœ‹ä»·æ ¼çš„RSocketå®¢æˆ·ç«¯ã€‚åœ¨ä¸‹ä¸€èŠ‚ï¼Œæˆ‘ä»¬ä¼šçœ‹ä¸€ä¸‹å¦‚ä½•ä»ä½¿ç”¨<code class="highlighter-rouge">WebClientStockClient</code>åˆ‡æ¢åˆ°<code class="highlighter-rouge">RSocketStockClient</code>ã€‚</p>

<p><a href="https://github.com/zwt-io/rsb/">å…¨éƒ¨ä»£ç åœ¨ GitHub</a>ï¼šhttps://github.com/zwt-io/rsb/</p>
:ET